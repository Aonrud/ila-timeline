/*! Timeline
 *Copyright (C) 2021 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=s()}(this,(function(){"use strict";const t="http://www.w3.org/2000/svg";class s{static draw({start:s,end:i,stroke:e,colour:o,markers:n=[],dashes:r="",title:h=""}={}){const c=2*e,a=i.x-s.x,d=i.y-s.y,l={x1:c,y1:c,x2:a+c,y2:d+c};i.x<s.x&&(l.x1+=Math.abs(a),l.x2+=Math.abs(a)),i.y<s.y&&(l.y1+=Math.abs(d),l.y2+=Math.abs(d));const u=Math.min(s.x,i.x)-c,m=Math.min(s.y,i.y)-c;let p=document.createElementNS(t,"svg");p.setAttribute("width",Math.abs(a)+2*c),p.setAttribute("height",Math.abs(d)+2*c),p.setAttribute("style","position: absolute; left: "+u+"px; top: "+m+"px");const f=this.drawLine(l,o,e,r,h);return f.setAttribute("data-coords",`[ ${s.x}, ${s.y} ], [ ${i.x}, ${i.y} ]`),p.append(f),p=this.t(p,n[0],"start",l,e,o),p=this.t(p,n[1],"end",l,e,o),p}static t(t,s,i,e,o,n){return"circle"==s&&t.append(this.i(i,e,o,n)),"square"==s&&t.append(this.o(i,e,o,n)),"dots"==s&&"end"==i&&(t.setAttribute("width",parseInt(t.getAttribute("width"))+2*o),t.append(this.h(e,o,n))),t}static o(t,s,i,e){let[o,n]=[s.x1-i,s.y1-i];return[o,n]=[s.x2-i,s.y2-i],this.drawSquare(o,n,2.5*i,e)}static i(t,s,i,e){let[o,n]=[s.x1,s.y1];return[o,n]=[s.x2,s.y2],this.drawCircle(o,n,i,e)}static h(t,s,i){let e=t.x2;t.x2<t.x1&&(e=t.x2-5*s),t.x2>t.x1&&(e=t.x2+5*s);let o=t.y2;t.y2<t.y1&&(o=t.y2-2*s),t.y2>t.y1&&(o=t.y2+2*s);const n={x1:t.x2,y1:t.y2,x2:e,y2:o};return this.drawLine(n,i,s,`0 ${s} ${s} ${s} ${s}`)}static drawLine(s,i,e,o="",n=""){const r=document.createElementNS(t,"line");return r.setAttribute("x1",s.x1),r.setAttribute("y1",s.y1),r.setAttribute("x2",s.x2),r.setAttribute("y2",s.y2),r.setAttribute("stroke",i),r.setAttribute("stroke-width",e),r.setAttribute("stroke-dasharray",o),n&&r.append(this.l(n)),r}static drawCircle(s,i,e,o,n=""){const r=document.createElementNS(t,"circle");return r.setAttribute("cx",s),r.setAttribute("cy",i),r.setAttribute("r",e),r.setAttribute("fill",o),n&&r.append(this.l(n)),r}static drawSquare(s,i,e,o,n=""){const r=document.createElementNS(t,"rect");return r.setAttribute("x",s),r.setAttribute("y",i),r.setAttribute("width",e),r.setAttribute("height",e),r.setAttribute("fill",o),n&&r.append(this.l(n)),r}static l(s){const i=document.createElementNS(t,"title");return i.append(document.createTextNode(s)),i.dataset.title=s,i}}class i{constructor(t,s=1900,i=1){this.u=t,this.m=s,this.p=Array.from(Array(i+1),(()=>new Array(t).fill(!1)))}applyBlocks(t){for(const s of t)if(s.dataset.hasOwnProperty("row")&&s.dataset.hasOwnProperty("start")&&s.dataset.hasOwnProperty("end"))try{this._(s.dataset.row,this.k(s.dataset.start),this.k(s.dataset.end))}catch(t){console.log(`${t}: called for ${entry.id} with row ${row}`)}}setRows(t){const s=[...t].filter((t=>t.dataset.hasOwnProperty("row"))),i=[...t].filter((t=>!t.dataset.hasOwnProperty("row")));for(const t of s)this.g(t);for(const t of i)this.g(t);return this.rows}g(t){const s=this.k(t.dataset.start),i=this.k(this.I(t));let e=null,o=null,n=null;if(t.dataset.split&&(e=document.getElementById(t.dataset.split)),t.dataset.merge){const s=document.getElementById(t.dataset.merge);s.dataset.split!==t.id&&(e=s)}t.dataset.fork&&(e=document.getElementById(t.dataset.fork.split(" ")[0])),e&&null===n&&(e.dataset.row||this.g(e),n=parseInt(e.dataset.row)),t.dataset.fork&&(o=document.getElementById(t.dataset.fork.split(" ")[1]),o.dataset.row||this.g(o),this.$(e.dataset.row,this.k(e.dataset.start)-1,this.k(e.dataset.start)-1),this.$(o.dataset.row,this.k(o.dataset.start)-1,this.k(o.dataset.start)-1),n=Math.round((parseInt(e.dataset.row)+parseInt(o.dataset.row))/2));const r=this.S(t,s,i,n);t.dataset.row=r,this.v(t);try{this._(r,s,i);const e=document.querySelector('*[data-find="'+t.id+'"]');null!==e&&(console.log(`Blocking ${r} for ${t.id} (${e.dataset.start} to ${e.dataset.end}`),this._(r,this.k(e.dataset.start),this.k(e.dataset.end)))}catch(s){console.log(`${s}: called for ${t.id} with row ${r}`)}t.dataset.fork&&(this._(e.dataset.row,this.k(e.dataset.start)-1,this.k(e.dataset.start)-1),this._(o.dataset.row,this.k(o.dataset.start)-1,this.k(o.dataset.start)-1))}k(t){return parseInt(t)-parseInt(this.m)}get rows(){return this.p.length}v(t){if(t.dataset.become){const s=document.getElementById(t.dataset.become);if(s.dataset.row){const t=s.dataset.start-this.m,i=s.dataset.end-this.m;this.$(s.dataset.row,t,i)}s.dataset.row=t.dataset.row,this.v(s)}}S(t,s,i,e=null){return t.dataset.row?t.dataset.row:e?this.M(parseInt(e),s,i):this.F(s,i)}I(t){let s=t.dataset.end;return t.dataset.become&&(s=this.I(document.getElementById(t.dataset.become))),s}F(t,s){for(let i=0;i<this.rows;i++)if(this.C(i,t,s))return i;return this.G(),this.rows-1}M(t,s,i){let e=t,o=t;if(this.C(t,s,i))return t;for(;e>-1&&!this.C(e,s,i);)e--;for(;o<this.rows&&!this.C(o,s,i);)o++;return-1==e&&o==this.rows?(this.G(),this.rows-1):o==this.rows?e:-1==e?o:t-e<=o-t?e:o}G(){this.p.push(new Array(this.u).fill(!1))}C(t,s,i){s===i&&(i+=1);return this.p[t].slice(s,i).every((t=>!1===t))}_(t,s,i){this.P(t,s,i,!0)}$(t,s,i){this.P(t,s,i,!1)}P(t,s,i,e){if(!this.p[t])throw new Error(`Attempt to mark non-existent grid row ${t}`);let o=0;for(;o<i-s;)this.p[t][s+o]=e,o++;s>0&&(this.p[t][s-1]=e),i<this.p[0].length-1&&(this.p[t][i]=e)}}function e(t,s){let i={};for(const e in t)s.hasOwnProperty(e)?i[e]=s[e]:i[e]=t[e];return i}const o={yearStart:1900,yearEnd:(new Date).getFullYear()+1,strokeWidth:4,yearWidth:50,rowHeight:50,padding:5,strokeColour:"#999",boxWidth:100,guides:!0,guideInterval:5,entrySelector:"div",linkDashes:"4",irregularDashes:"88 4 4 4"};class n{constructor(t,s={}){this.T=this.R(s),this.q(),this.D=document.getElementById(t),this.A=document.querySelectorAll("#"+t+" > "+this.T.entrySelector+":not(.timeline-exclude):not(.timeline-block)"),this.W=document.querySelectorAll(".timeline-block")}R(t){const s=e(o,t);return s.boxHeight=s.rowHeight-2*s.padding,s.boxMinWidth=s.boxHeight,s}B(t,s){this.T[t]=s}create(){return this.H(),this.L(),this.O(),!0===this.T.guides&&this.j(),this.D}H(){this.J();const t=this.N().setRows(this.A);this.B("rows",t),this.D.classList.add("timeline-container"),this.D.style.height=(this.T.rows+2)*this.T.rowHeight+"px",this.D.style.width=(this.T.yearEnd+1-this.T.yearStart)*this.T.yearWidth+"px",this.X()}J(){for(const t of this.A)t.classList.add("entry"),t.dataset.end=this.Y(t)}N(){const t=this.T.yearEnd-this.T.yearStart;let s=1;for(const t of this.D.querySelectorAll(this.T.entrySelector+":not(.timeline-exclude), .timeline-block"))parseInt(t.dataset.row)>s&&(s=parseInt(t.dataset.row));const e=new i(t,this.T.yearStart,s);return e.applyBlocks(this.W),this.B("rows",e.rows),e}K(t){for(const s of this.A)t.setEntryRow(s);this.B("rows",t.rows)}X(){for(const t of this.A)t.style.left=this.U(t.dataset.start)+"px",t.style.top=(parseInt(t.dataset.row)+1)*this.T.rowHeight+this.T.padding+"px",t.dataset.colour&&(t.style.borderColor=t.dataset.colour),!0===this.V(t)&&t.classList.add("min");for(const t of this.D.querySelectorAll(this.T.entrySelector+"[data-become]"))t.dataset.start==document.getElementById(t.dataset.become).dataset.start&&(t.style.left=parseFloat(t.style.left)-this.T.boxMinWidth/2+"px",document.getElementById(t.dataset.become).style.left=parseFloat(document.getElementById(t.dataset.become).style.left)+this.T.boxMinWidth/2+"px")}O(){const t=document.createElement("div");t.classList.add("dates");let s=this.T.yearStart;for(;s<this.T.yearEnd;){const i=document.createElement("date");i.style.left=this.U(s)+"px";const e=document.createTextNode(s);i.append(e),t.append(i),s+=5}this.D.prepend(t);const i=t.cloneNode(!0);i.style.top=this.T.rows*this.T.rowHeight+"px",this.D.append(i)}j(){let t=this.T.yearStart;for(;t<Math.ceil(this.T.yearEnd/this.T.guideInterval)*this.T.guideInterval;){const s=document.createElement("div");s.classList.add("guide"),s.style.left=this.U(t)+"px",s.style.width=this.T.yearWidth*this.T.guideInterval+"px",(t-this.T.yearStart)/this.T.guideInterval%2==1&&s.classList.add("odd"),this.D.append(s),t+=this.T.guideInterval}}L(){for(const t of this.A){const i=t.dataset.colour?t.dataset.colour:this.T.strokeColour,e="true"==t.dataset.irregular?this.T.irregularDashes:"";let o="",n="end",r=this.Z(t,"right"),h={x:this.U(t.dataset.end),y:r.y};if(t.dataset.hasOwnProperty("merge")||t.dataset.hasOwnProperty("fork")||t.dataset.hasOwnProperty("become")||(o=t.dataset.endEstimate?"dots":"circle"),t.dataset.hasOwnProperty("become")&&(h=this.Z(document.getElementById(t.dataset.become),"left"),n="become"),t.dataset.hasOwnProperty("merge")){t.dataset.start==t.dataset.end&&(h.x+=this.T.yearWidth);const e={x:h.x,y:this.tt(document.getElementById(t.dataset.merge))};h.x=h.x-this.T.yearWidth;const o=s.draw({start:h,end:e,stroke:this.T.strokeWidth,colour:i});o.classList.add("merge"),this.D.append(o),n="merge"}if(t.dataset.start!==t.dataset.end){const t=s.draw({start:r,end:h,stroke:this.T.strokeWidth,colour:i,markers:["",o],dashes:e});t.classList.add(n),this.D.append(t)}t.dataset.hasOwnProperty("split")&&this.st(t,i),t.dataset.hasOwnProperty("fork")&&this.it(t,i),t.dataset.hasOwnProperty("links")&&this.et(t,i)}}st(t,i){const e=document.getElementById(t.dataset.split);let o="top";parseInt(t.dataset.row)<parseInt(e.dataset.row)&&(o="bottom");const n={x:this.U(t.dataset.start),y:this.tt(e)},r=this.Z(t,o),h=s.draw({start:n,end:r,stroke:this.T.strokeWidth,colour:i});h.classList.add("split"),this.D.append(h)}it(t,i){const e=t.dataset.fork.split(" "),o=parseInt(t.dataset.end),n={x:this.U(o),y:this.tt(t)},r={x:this.U(o+1),y:this.tt(document.getElementById(e[0]))},h={x:this.U(o+1),y:this.tt(document.getElementById(e[1]))},c=s.draw({start:n,end:r,stroke:this.T.strokeWidth,colour:i}),a=s.draw({start:n,end:h,stroke:this.T.strokeWidth,colour:i});c.classList.add("fork"),a.classList.add("fork"),this.D.append(c,a)}et(t,i){const e=t.dataset.links.split(" ");let o={top:-1,bottom:-1,left:-1,right:-1};for(const n of e){const e=document.getElementById(n);e||console.warn(`${t.id} links to non-existant ID ${n}`);let r,h,c={x:0,y:0},a={x:0,y:0};const d=parseInt(t.dataset.row),l=parseInt(e.dataset.row);d===l&&t.dataset.start<e.dataset.start&&(o.right=o.right+1,r="right",h="left"),d===l&&t.dataset.start>e.dataset.start&&(o.left=o.left+1,r="left",h="right"),d>l&&(o.top=o.top+1,r="top",h="bottom"),d<l&&(o.bottom=o.bottom+1,r="bottom",h="top"),c=this.Z(t,r,o[r]),a={x:c.x,y:this.tt(e)},t.dataset.start>=e.dataset.end&&(a.x=this.U(e.dataset.end)),t.dataset.start==e.dataset.start&&(a=this.Z(e,h));const u=s.draw({start:c,end:a,stroke:this.T.strokeWidth/2,colour:i,markers:["square","square"],dashes:this.T.linkDashes});u.classList.add("link"),this.D.append(u)}}q(){const t=document.documentElement;t.style.setProperty("--timeline-year-width",this.T.yearWidth+"px"),t.style.setProperty("--timeline-row-height",this.T.rowHeight+"px"),t.style.setProperty("--timeline-box-width",this.T.boxWidth+"px"),t.style.setProperty("--timeline-box-height",this.T.boxHeight+"px"),t.style.setProperty("--timeline-box-width-min",this.T.boxHeight+"px"),t.style.setProperty("--timeline-padding",this.T.padding+"px"),t.style.setProperty("--timeline-stroke-colour",this.T.strokeColour)}Z(t,s,i=0){const e=window.getComputedStyle(t),o=parseFloat(t.style.left),n=parseFloat(t.style.top),r=parseFloat(e.getPropertyValue("width")),h=parseFloat(e.getPropertyValue("height"));switch(s){case"left":return{x:o,y:n+h/2+5*i};case"right":return{x:o+r,y:n+h/2+5*i};case"top":return{x:o+r/2+5*i,y:n};case"bottom":return{x:o+r/2+5*i,y:n+h};default:throw`Invalid element side specified: Called with ${s}. Entry: ${t}`}}Y(t){if(t.dataset.end)return parseInt(t.dataset.end);if(t.dataset.become)return parseInt(document.getElementById(t.dataset.become).dataset.start);if(t.dataset.fork&&!t.dataset.end){const s=t.dataset.fork.split(" "),i=document.getElementById(s[0]),e=document.getElementById(s[1]);return parseInt(Math.max(i.dataset.start,e.dataset.start))}return parseInt(this.T.yearEnd)}V(t){const s=t.dataset.start;return t.dataset.end-s<this.T.boxWidth/this.T.yearWidth}ot(t){return parseFloat(t.style.left)+this.T.boxWidth/2}tt(t){return parseFloat(t.style.top)+this.T.boxHeight/2}U(t){return parseInt((t-this.T.yearStart)*this.T.yearWidth)}}const r={panzoom:!1,findForm:"timeline-find",zoomIn:"timeline-zoom-in",zoomOut:"timeline-zoom-out",zoomReset:"timeline-zoom-reset"};return class{constructor(t="diagram",s={}){this.D=t,this.nt(s)}create(){const t=new n(this.D,this.rt);this.ht=t.create(),!0===this.T.panzoom&&(this.ct(),this.at(),window.addEventListener("hashchange",(()=>this.dt()))),location.hash&&setTimeout((()=>{this.dt()}))}nt(t){this.T=e(r,t),this.rt=e(o,t)}panToEntry(t){if(!0!==this.T.panzoom)throw new Error("Panzoom not enabled. Enable Panzoom to use the pan-to-entry feature.");if(void 0===this.lt)throw new Error("Panzoom module missing. Include Panzoom to use the pan-to-entry feature.");const s=document.getElementById(t),i=window.innerWidth/2-parseInt(s.style.left)-this.rt.boxWidth/2,e=window.innerHeight/2-parseInt(s.style.top)-this.rt.rowHeight/2;this.lt.zoom(1),this.lt.pan(i,e);const o=new CustomEvent("timelineFind",{detail:{id:t,name:s.innerText}});document.getElementById(this.D).dispatchEvent(o),setTimeout((()=>{s.classList.add("highlight","hover")}),500),setTimeout((()=>{s.classList.remove("highlight","hover")}),2e3)}at(){const t=document.getElementById(this.T.zoomIn),s=document.getElementById(this.T.zoomOut),i=document.getElementById(this.T.zoomReset),e=document.getElementById(this.T.findForm);t&&t.addEventListener("click",this.lt.zoomIn),s&&s.addEventListener("click",this.lt.zoomOut),i&&i.addEventListener("click",(()=>this.lt.zoom(1))),e&&this.ut(e)}ut(t){const s=document.createElement("input");s.name="find-id",s.style.display="none",t.append(s);const i=t.querySelector("input[name=finder]"),e=document.createElement("div"),o=document.createElement("div"),n=document.createElement("ul");e.classList.add("filtered-entries"),e.appendChild(o),o.appendChild(n),i.parentNode.insertBefore(e,i),e.appendChild(i),i.autocomplete="off",o.style.width=i.offsetWidth+"px";const r={form:t,finder:i,id:s,results:n};this.ft=r,r.finder.value="",t.addEventListener("input",(t=>this.wt(t))),t.addEventListener("submit",(t=>this.yt(t))),n.addEventListener("click",(t=>this.xt(t)))}wt(t){const s=t.target.value;if(""===s.trim())return void(this.ft.results.innerHTML="");const i=this._t(s),e=this.ft.results;e.innerHTML="";for(const t of i){const s=document.createElement("li");s.dataset.id=t.id,s.innerText=t.name,e.append(s)}}_t(t){return[...document.querySelectorAll(".entry")].map((t=>({id:t.id,name:t.innerText}))).filter((s=>s.name.toLowerCase().includes(t.toLowerCase())))}xt(t){if("li"!==t.target.localName)return null;const s=this.ft.form,i=this.ft.finder,e=this.ft.id;i.value=t.target.innerText,e.value=t.target.dataset.id,s.requestSubmit()}yt(t){t.preventDefault();const s=t.target.querySelector("input[name=find-id]").value;t.target.querySelector("input[name=finder]").value,document.getElementById(s)&&this.panToEntry(s),this.ft.results.innerHTML="",this.ft.finder.value=""}ct(){if("undefined"==typeof Panzoom)throw new Error("Missing dependency. External Panzoom library (@panzoom/panzoom) is required to use the panzoom feature.");const t=document.createElement("div");t.classList.add("pz-wrap"),this.ht.parentNode.insertBefore(t,this.ht),t.appendChild(this.ht),this.lt=Panzoom(this.ht,{contain:"outside",maxScale:3,minScale:.5,step:.1,handleStartEvent:t=>{t.preventDefault()}}),this.ht.parentElement.addEventListener("wheel",this.lt.zoomWithWheel)}dt(){const t=location.hash.replace("#find-","");document.getElementById(t)&&this.lt&&this.panToEntry(t)}}}));
